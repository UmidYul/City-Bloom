<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ú–∞–≥–∞–∑–∏–Ω ‚Äî City Bloom</title>
    <link rel="stylesheet" href="/styles.css">
</head>

<body>
    <div class="app">
        <header class="site-header">
            <a class="logo" href="/">City Bloom</a>
            <div id="notifications-container"></div>
        </header>

        <main>
            <!-- Balance Header -->
            <div class="card" style="margin-bottom:16px">
                <div style="text-align:center">
                    <div class="text-small muted">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                    <div style="font-size:32px;font-weight:700;color:var(--accent);line-height:1;margin:8px 0"
                        id="userBalance">0</div>
                    <div class="text-small muted">–ë–∞–ª–ª–æ–≤</div>
                </div>
            </div>

            <!-- Category Pills -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                <button type="button" class="pill active" data-category="rewards">üéÅ –¢–æ–≤–∞—Ä—ã</button>
                <button type="button" class="pill" data-category="promos">üéüÔ∏è –ú–æ–∏ –ø—Ä–æ–º–æ</button>
            </div>

            <!-- Rewards Tab -->
            <div id="rewardsTab">
                <!-- Category Filter -->
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:16px"
                    id="categoryFilter">
                    <button type="button" class="filter-btn active" data-filter="all">–í—Å–µ</button>
                    <button type="button" class="filter-btn" data-filter="favorites">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                    <button type="button" class="filter-btn" data-filter="food">üçî –ï–¥–∞</button>
                    <button type="button" class="filter-btn" data-filter="entertainment">üé¨ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
                    <button type="button" class="filter-btn" data-filter="shopping">üõçÔ∏è –ü–æ–∫—É–ø–∫–∏</button>
                    <button type="button" class="filter-btn" data-filter="services">üíº –£—Å–ª—É–≥–∏</button>
                    <button type="button" class="filter-btn" data-filter="other">üì¶ –î—Ä—É–≥–æ–µ</button>
                </div>

                <div id="products" style="display:grid;gap:12px">
                    <!-- Skeleton loaders -->
                    <div class="card">
                        <div style="display:flex;gap:12px">
                            <div class="skeleton" style="width:80px;height:80px;border-radius:8px;flex-shrink:0"></div>
                            <div style="flex:1">
                                <div class="skeleton" style="height:20px;width:70%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:16px;width:50%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:24px;width:40%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display:flex;gap:12px">
                            <div class="skeleton" style="width:80px;height:80px;border-radius:8px;flex-shrink:0"></div>
                            <div style="flex:1">
                                <div class="skeleton" style="height:20px;width:70%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:16px;width:50%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:24px;width:40%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display:flex;gap:12px">
                            <div class="skeleton" style="width:80px;height:80px;border-radius:8px;flex-shrink:0"></div>
                            <div style="flex:1">
                                <div class="skeleton" style="height:20px;width:70%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:16px;width:50%;margin-bottom:8px"></div>
                                <div class="skeleton" style="height:24px;width:40%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Promos Tab -->
            <div id="promosTab" style="display:none">
                <div id="promosList"></div>
            </div>
        </main>
    </div>

    <!-- Promo Modal -->
    <div id="promoModal" class="modal-backdrop"
        style="display:none;align-items:center;justify-content:center;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;padding:20px">
        <div class="card" style="max-width:360px;width:100%;padding:24px">
            <h3 id="promoTitle" style="margin-top:0;margin-bottom:8px">Your Promo Code</h3>
            <div id="promoOrg" class="muted text-medium" style="margin-bottom:16px"></div>

            <!-- QR Code -->
            <div style="text-align:center;margin-bottom:20px">
                <div id="qrcode" style="display:inline-block;padding:16px;background:white;border-radius:12px"></div>
            </div>

            <div style="margin-bottom:16px">
                <label class="text-small muted">Code:</label>
                <div style="margin-top:8px;padding:16px;background:var(--input-bg);border-radius:12px;font-weight:700;font-size:18px;font-family:monospace;text-align:center;cursor:pointer;user-select:all"
                    id="promoCode" onclick="copyPromoCode()">LOADING...</div>
                <div style="text-align:center;font-size:12px;color:var(--text-gray);margin-top:8px">
                    Tap to copy
                </div>
            </div>

            <div class="muted text-small text-center" id="promoExpiry" style="margin-bottom:16px"></div>

            <button type="button" id="closePromo" style="width:100%">Close</button>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-backdrop"
        style="display:none;align-items:center;justify-content:center;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2000;padding:20px">
        <div class="card" style="max-width:400px;width:100%;padding:24px">
            <h3 id="reviewProductTitle" style="margin-top:0;margin-bottom:16px">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>

            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:500">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</label>
                <div id="starRating" style="display:flex;gap:8px;font-size:32px;cursor:pointer">
                    <span data-rating="1">‚≠ê</span>
                    <span data-rating="2">‚≠ê</span>
                    <span data-rating="3">‚≠ê</span>
                    <span data-rating="4">‚≠ê</span>
                    <span data-rating="5">‚≠ê</span>
                </div>
            </div>

            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;font-weight:500">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <textarea id="reviewComment" rows="4" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –æ–ø—ã—Ç–æ–º..."
                    style="width:100%;padding:12px;border-radius:var(--radius-input);border:1px solid var(--border-light);font-family:inherit;resize:vertical"></textarea>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <button type="button" id="cancelReview" class="ghost">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" id="submitReview">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <span class="icon">üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </a>
        <a href="/map" class="nav-item">
            <span class="icon">üó∫Ô∏è</span>
            <span>–ö–∞—Ä—Ç–∞</span>
        </a>
        <a href="/exchange" class="nav-item active">
            <span class="icon">üíù</span>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </a>
        <a href="/ranking" class="nav-item">
            <span class="icon">üèÜ</span>
            <span>–†–µ–π—Ç–∏–Ω–≥</span>
        </a>
        <a href="#" class="nav-item" id="profileNavLink">
            <span class="icon">üë§</span>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
    </nav>

    <script>
        function copyPromoCode() {
            const code = document.getElementById('promoCode').textContent
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('promoCode')
                const orig = btn.textContent
                btn.textContent = '‚úì Copied!'
                setTimeout(() => btn.textContent = orig, 1500)
            }).catch(err => {
                console.error('Failed to copy:', err)
                alert('Could not copy code')
            })
        }

        // Load user profile link
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const meRes = await fetch('/api/me')
                if (meRes.ok) {
                    const me = await meRes.json()
                    document.getElementById('profileNavLink').href = `/profile/${me.id}`
                }
            } catch (err) {
                console.error('Failed to load user:', err)
            }
        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="/nav.js"></script>
    <script src="/notifications.js"></script>
    <script src="/exchange.js"></script>
</body>

</html>